## Building the new Phalcon Website - Middleware - Part 3

This is the third part of the "Building the new Phalcon Website" series. 
[Part 1]()
[Part 2]() 

### Middleware
The core of the application is its Middleware. We discussed how the middleware is set up in [Part 2]() in the `initRoutes()` method of our `AbstractBootstrap` class. Note that this only applies to our main application and not the CLI.  

#### Setup
Middleware needs to be attached to specific events in our events manager. These events are:

* `before`: This attaches the middleware to the event that fires before the handler has been executed. 
* `after`: This attaches the middleware to the event that fires after the handler has been executed. 
* `final`: This attaches the middleware to the event that fires after the response has been sent to the caller.  

You can attach as many middleware classes in each of these events. They will be processed in a sequential manner, i.e. the first one registered gets processed first, then the second one etc.

#### Execution
Each middleware class has specific events in it that get executed (if present). These are methods present in each middleware class. The main method that gets executed is `call`

```php
public function call(Micro $application)
{
    return true;
}
```

The events present in each middleware class are:

* `beforeHandleRoute` - Called before any routes are matched
* `beforeExecuteRoute` - Called when a route is matched and a valid handler exists but has not been executed
* `afterExecuteRoute` - Called after executing a handler
* `beforeNotFound` - Called when a route has not been matched
* `afterHandleRoute` - Called after the handler has been executed successfully	

For instance for the `NotFoundMiddleware` we have:

```php
public function beforeNotFound()
{
    $language = $this->registry->language;
    $redirect= sprintf('/%s/404', $language);

    $this->response->redirect($redirect);
    $this->response->send();

    return false;
}
```

Returning `false` stops the execution of the application. As we can see above, since the `beforeNotFound` event has been triggerred, we need to first pick up the `$language` from the registry, set up the 404 route and then redirect the caller to the relevant handler/action. 

#### `EnvironmentMiddleware`
This middleware has been attached to the `before` event, so it will be executed before a handler starts processing


```php
public function call(Micro $application)
{
    /**
     * This is where we calculate what language we need to work with
     * and what slug has been requested
     */
    $params   = $application->router->getParams();
    $language = $this->getLang($application, 'en');
    $slug     = $application->utils->fetch($params, 'slug', 'index');
    $image    = $application->utils->fetch(
        $this->getImageMap($application),
        $language,
        'en'
    );

    /**
     * These are needed for all pages
     */
    $application->registry->language      = $language;
    $application->registry->slug          = $slug;
    $application->registry->imageLanguage = $image;
    $application->registry->menuLanguages = $this->getMenuLanguages($application, $language);
    $application->registry->version       = $application->config->get('app')->get('version');

    switch ($slug) {
        /**
         * Contributors are needed only in the front page or 'team'
         */
        case 'team':
        case 'index':
        case '':
            $application->registry->contributors = $this->getContributors();
            break;
        /**
         * Releases are needed in 'windows'
         */
        case 'windows':
            $application->registry->releases = $this->getReleases();
            break;
    }

    return true;
}
```
First we get a few parameters that have been passed to our application. One of those is the language. We use the `getLang()` method to check if the passed language exists. If not, we try to detect the browser language and if that fails it defaults to English.

The `getLang()` method is located in the `LanguageTrait` (`app/library/Traits`).

#### `NotFoundMiddleware`
#### `RedirectMiddleware`
#### `AssetsMiddleware`
#### `ViewMiddleware`



### Conclusion

We have looked at the boostrap of the application and each service setup for both the CLI and the main application. In the next part of these series we will discuss the middleware. 





